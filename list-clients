#!/bin/sh

LEASES="/tmp/dhcp.leases"
MAC_VENDORS="/etc/mac-vendors.db"

# Mac vendor cahce
[ -f "$MAC_VENDORS" ] || touch "$MAC_VENDORS"
MAC_CACHE=$(cat "$MAC_VENDORS" 2>/dev/null)

# Print header
printf "%-25s %-17s %-25s %-24s %-10s %-10s %-10s\n" "IP Address" "MAC Address" "Vendor (MAC)" "Hostname" "Iface" "Method" "State"
printf "%s\n" "-----------------------------------------------------------------------------------------------------------------------------"

ONLN=1

ip neigh show | while read -r l; do
	ip=$(echo "$l"   | awk '{print $1}')
	iface=$(echo "$l"| sed -n 's/.* dev \([^ ]*\).*/\1/p')
	mac=$(echo "$l"  | sed -n 's/.* lladdr \([^ ]*\).*/\1/p')
	state=$(echo "$l"| awk '{print $NF}')

	[ -z "$ip" ] && ip="-"
	[ -z "$iface" ] && iface="-"
	[ -z "$mac" ] && mac="-"
	[ -z "$state" ] && state="-"

	# Hostname & Method detection
	host=$(awk -v mac="$mac" '$2 == mac {print $4}' "$LEASES" 2>/dev/null)
	if [ -n "$host" ]; then
		meth="DHCP"
	elif grep -qi "^[[:space:]]*$mac[[:space:]]" /etc/ethers 2>/dev/null; then
		meth="Static"
		[ -z "$host" ] && host=$(awk -v mac="$mac" 'BEGIN{IGNORECASE=1} $1==mac {print $2}' /etc/ethers 2>/dev/null)
	else
		meth="Static/?"
	fi
	[ -z "$host" ] && host="-"

	# Mac vend lookup with local cache
	vend="-"
	prefix=$(echo "$mac" | tr '[:lower:]' '[:upper:]' | cut -d: -f1-3)

	if [ -n "$prefix" ]; then
		vend=$(echo "$MAC_CACHE" | grep -i "^$prefix=" | head -n1 | cut -d= -f2-)
	fi

	if [ -z "$vend" ] && [ "$prefix" != "---" ] && [ "$ONLN" -eq 1 ]; then
		t0=$(date +%s)
		resp=$(wget -qO- "https://api.macvendors.com/$mac" 2>/dev/null)
		t=$(date +%s)
		elap=$((t - t0))

		if [ "$elap" -gt 4 ]; then
			ONLN=0
		fi

		if [ -n "$resp" ]; then
			vend="$resp"
			echo "$prefix=$vend" >> "$MAC_VENDORS"
			MAC_CACHE="${MAC_CACHE}${MAC_CACHE:+
}$prefix=$vend"
		fi
	fi
	[ -z "$vend" ] && vend="-"

	printf "%-25s %-17s %-25s %-24s %-10s %-10s %-10s\n" "$ip" "$mac" "$vend" "$host"  "$iface" "$meth" "$state"

done | sort -t. -k1,1n -k2,2n -k3,3n -k5,5n