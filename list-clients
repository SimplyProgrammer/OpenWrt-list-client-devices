#!/bin/sh

LEASES="/tmp/dhcp.leases"
MAC_VENDORS="/etc/mac-vendors.db"

# Mac vendor cahce
MAC_CACHE=$(cat "$MAC_VENDORS" 2>/dev/null)

# Print header
printf "%-25s %-17s %-25s %-24s %-18s %-10s %-10s\n" "IP Addr" "MAC Addr" "Vendor (MAC)" "Hostname" "Iface" "Method" "State"
printf "%s\n" "-------------------------------------------------------------------------------------------------------------------------------------"

ONLN=1

ip neigh show | sort | while read -r l; do
	ip=$(echo "$l"   | awk '{print $1}')
	ifc=$(echo "$l"  | sed -n 's/.* dev \([^ ]*\).*/\1/p')
	mac=$(echo "$l"  | sed -n 's/.* lladdr \([^ ]*\).*/\1/p')
	state=$(echo "$l"| awk '{print $NF}')

	[ -z "$ip" ] && ip="-"
	[ -z "$ifc" ] && ifc="-"
	[ -z "$mac" ] && mac="-"
	[ -z "$state" ] && state="-"

	# Hostname & Method detection
	host=$(awk -v mac="$mac" '$2 == mac {print $4}' "$LEASES" 2>/dev/null)
	if [ -n "$host" ]; then
		meth="DHCP"
	elif grep -qi "^[[:space:]]*$mac[[:space:]]" /etc/ethers 2>/dev/null; then
		meth="Static"
		[ -z "$host" ] && host=$(awk -v mac="$mac" 'BEGIN{IGNORECASE=1} $1==mac {print $2}' /etc/ethers 2>/dev/null)
	else
		meth="Static/?"
	fi
	[ -z "$host" ] && host="-"

	# Mac vend lookup with local cache
	vend="-"
	pref=$(echo "$mac" | tr '[:lower:]' '[:upper:]' | cut -d: -f1-3)

	if [ -n "$pref" ]; then
		vend=$(echo "$MAC_CACHE" | grep -i "^$pref=" | head -n1 | cut -d= -f2-)
	fi

	if [ -z "$vend" ] && [ "$pref" != "---" ] && [ "$ONLN" -eq 1 ]; then
		t0=$(date +%s)
		resp=$(wget -qO- "https://api.macvendors.com/$mac" 2>/dev/null)
		t=$(date +%s)
		elap=$((t - t0))

		if [ "$elap" -gt 4 ]; then
			ONLN=0
		fi

		if [ -n "$resp" ]; then
			vend="$resp"
			echo "$pref=$vend" >> "$MAC_VENDORS"
			MAC_CACHE="${MAC_CACHE}${MAC_CACHE:+
}$pref=$vend"
		fi
	fi
	[ -z "$vend" ] && vend="-"

	owrtIfc=$(uci show network | grep "$ifc" | cut -d. -f2 | cut -d= -f1 | head -n1)
	[ -z "$owrtIfc" ] && owrtIfc="-"

	printf "%-25s %-17s %-25s %-24s %-18s %-10s %-10s\n" "$ip" "$mac" "$vend" "$host" "$owrtIfc ($ifc)" "$meth" "$state"
done